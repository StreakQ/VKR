<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Назначение научным руководителям тем</title>
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
    }
    table, th, td {
      border: 1px solid black;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    .theme-row {
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <h1>Назначение научным руководителям тем</h1>

  <form id="advisers_to_themes_form" method="POST" action="/assign_advisers_to_themes">
    <table id="advisers_to_themes_table">
      <thead>
        <tr>
          <th>Научный руководитель</th>
          <th>Связанные темы</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>
        <!-- Отображение существующих назначений -->
        {% for adviser_id, theme_ids in grouped_assignments.items() %}
          <tr class="adviser-row">
            <!-- Выпадающий список научных руководителей -->
            <td>
              <select name="adviser_{{ loop.index }}" class="adviser-dropdown">
                {% for adviser in advisers %}
                  <option value="{{ adviser.adviser_id }}"
                    {% if adviser.adviser_id == adviser_id %}selected{% endif %}>
                    {{ adviser.firstname }} {{ adviser.lastname }}
                  </option>
                {% endfor %}
              </select>
            </td>
            <!-- Темы -->
            <td>
              <div class="themes-container">
                {% for theme_id in theme_ids %}
                  <div class="theme-row">
                    <select name="theme_{{ loop.index0 }}[]" class="theme-dropdown">
                      {% for theme in themes %}
                        <option value="{{ theme.theme_id }}"
                          {% if theme.theme_id == theme_id %}selected{% endif %}>
                          {{ theme.theme_name }}
                        </option>
                      {% endfor %}
                    </select>
                    <button type="button" onclick="removeThemeRow(this)">Удалить</button>
                  </div>
                {% endfor %}
              </div>
              <button type="button" onclick="addThemeRow(this)">Добавить тему</button>
            </td>
            <!-- Действия -->
            <td>
              <button type="button" onclick="removeAdviserRow(this)">Удалить</button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    <button type="button" onclick="addAdviserWithThemes()">Добавить научного руководителя</button>
    <button type="submit">Сохранить</button>
  </form>

  <script>
    // Функция для добавления нового научного руководителя с темами
    function addAdviserWithThemes() {
      const tableBody = document.querySelector("#advisers_to_themes_table tbody");

      // Создаем строку для научного руководителя
      const adviserRow = document.createElement("tr");
      adviserRow.className = "adviser-row";

      // Ячейка с выпадающим списком научных руководителей
      const adviserCell = document.createElement("td");
      const adviserSelect = document.createElement("select");
      adviserSelect.name = "adviser_new";
      adviserSelect.className = "adviser-dropdown";

      // Добавляем пустой вариант
      const defaultOption = document.createElement("option");
      defaultOption.value = "";
      defaultOption.text = "-- Выберите научного руководителя --";
      adviserSelect.appendChild(defaultOption);

      // Добавляем научных руководителей
      {% for adviser in advisers %}
        const option = document.createElement("option");
        option.value = "{{ adviser.adviser_id }}";
        option.text = "{{ adviser.firstname }} {{ adviser.lastname }}";
        adviserSelect.appendChild(option);
      {% endfor %}

      adviserCell.appendChild(adviserSelect);
      adviserRow.appendChild(adviserCell);

      // Ячейка для тем
      const themesCell = document.createElement("td");
      const themesContainer = document.createElement("div");
      themesContainer.className = "themes-container";

      // Кнопка добавления темы
      const addThemeButton = document.createElement("button");
      addThemeButton.type = "button";
      addThemeButton.textContent = "Добавить тему";
      addThemeButton.onclick = () => addThemeRow(themesContainer);
      themesCell.appendChild(themesContainer);
      themesCell.appendChild(addThemeButton);

      adviserRow.appendChild(themesCell);

      // Пустая ячейка для действий
      const actionsCell = document.createElement("td");
      const removeButton = document.createElement("button");
      removeButton.type = "button";
      removeButton.textContent = "Удалить";
      removeButton.onclick = () => tableBody.removeChild(adviserRow);
      actionsCell.appendChild(removeButton);

      adviserRow.appendChild(actionsCell);

      tableBody.appendChild(adviserRow);
    }

    // Функция для добавления строки с темой
    function addThemeRow(container) {
    const themeRow = document.createElement("div");
    themeRow.className = "theme-row";

    // Выпадающий список тем
    const themeSelect = document.createElement("select");
    themeSelect.name = "theme_new[]"; // Уникальное имя для новой темы
    themeSelect.className = "theme-dropdown";

    // Добавляем пустой вариант
    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.text = "-- Выберите тему --";
    themeSelect.appendChild(defaultOption);

    // Добавляем темы
    {% for theme in themes %}
      const option = document.createElement("option");
      option.value = "{{ theme.theme_id }}";
      option.text = "{{ theme.theme_name }}";
      themeSelect.appendChild(option);
    {% endfor %}

    // Кнопка удаления темы
    const removeButton = document.createElement("button");
    removeButton.type = "button";
    removeButton.textContent = "Удалить";
    removeButton.onclick = () => container.removeChild(themeRow);

    themeRow.appendChild(themeSelect);
    themeRow.appendChild(removeButton);

    container.appendChild(themeRow);
  }
    // Функция для удаления строки с научным руководителем
    function removeAdviserRow(button) {
      const row = button.closest("tr");
      row.remove();
    }

    // Функция для удаления строки с темой
    function removeThemeRow(button) {
      const row = button.closest(".theme-row");
      row.remove();
    }
  </script>
</body>
</html>